### 01

目前有 5W 条类似于json 文件@instrument.json 里的仪表数据，如何通过 catboost 训练模型实现：输入是一条 json 文件里得数据，输出是该仪表所属于的具体仪表类型，比如不锈钢压力表。

我先快速查看项目代码结构与示例数据 `testdata/instrument.json`，以便给出基于你现有仓库的最小改动方案，并确定是否需要新增数据加载/特征工程与多分类配置支持。接着我会给出具体训练/推理脚本与配置改动。
Ran tool
Ran tool
Ran tool
Ran tool
Ran tool

我先并行查看现有模块和样例 JSON 的开头，确认是否已有 JSON 加载/扁平化工具与当前 CLI 的可扩展点，然后据此实现多分类 JSON 训练与单条 JSON 推理。
Ran tool
Ran tool
Ran tool
Ran tool
Ran tool
Ran tool

我要在训练入口中加入 JSON 数据加载、自动识别类别特征、以及保存特征元数据，随后新增一个预测入口用于对单条 JSON 记录进行推理。现在开始修改训练 CLI 并添加预测 CLI 与脚本入口。
Ran tool

我将新增预测命令行工具用于单条或多条 JSON 记录的推理，并在训练阶段写出的元数据基础上对输入进行对齐；同时在项目入口中注册该命令。接下来我会创建新文件并更新打包脚本。
Ran tool
Ran tool

我先检查刚新增的训练与预测脚本是否有语法或风格问题。随后会提供完整的训练与推理步骤、示例配置与命令。
Ran tool

我已经为项目加上了基于 JSON 的训练与推理能力：训练脚本支持直接读取 JSON（数组或 JSONL），自动识别类别特征并保存特征元数据；新增了推理命令行，支持对单条或多条 JSON 记录进行预测。

### 你要做的事（最少步骤）
- 标注数据集：在每条 JSON 记录里增加一个目标字段（例如 `label`），值为“具体仪表类型”（如“不锈钢压力表”）。
- 准备配置文件，指向你的 JSON 训练集并指定目标列与特征列。
- 运行训练命令，得到模型与元数据。
- 使用预测命令对单条或文件进行推理。

### 配置文件示例（用于多分类，直接训 JSON）
将下面内容保存为 `configs/instrument_multiclass.yaml`：
```yaml
data:
  train_json: testdata/instrument.json   # 也可用你自己的大文件
  target: label                          # 你的目标字段，需写入“不锈钢压力表”等真实类型
  # 建议显式列出特征，避免泄漏特征（id、时间戳、tag等）
  features:
    - function
    - instrument_type
    - instrument_name
    - location
    - assembly_material
    - assembly_installsize
    - assembly_substance
    - assembly_phase
    - assembly_density
    - process
    - direction
    - material
    - status
  categorical: auto                      # 自动将 object 列当作类别特征
model:
  loss_function: MultiClass
  iterations: 800
  learning_rate: 0.06
  depth: 8
  random_seed: 42
  verbose: false
fit:
  verbose: false
```

### 训练
```bash
pip install -e .[dev]
dalong-catboost --config configs/instrument_multiclass.yaml --out models/instrument.cbm
```
- 训练完成后会同时生成 `models/instrument.cbm.meta.json`，里面保存了特征列与类别列，供推理对齐使用。

### 推理（文件或单条 JSON）
- 多条（文件，支持 JSON 数组或 JSON Lines）：
```bash
dalong-catboost-predict --model models/instrument.cbm --input-file testdata/instrument.json --proba
```
- 单条（直接传 JSON 字符串；只需包含训练时的特征列，不必有 `label`）：
```bash
dalong-catboost-predict --model models/instrument.cbm --input '{"function":"PG","instrument_type":"pressure","instrument_name":"压力","location":"V20805A","assembly_material":"S31603"}' --proba
```
- 输出为预测类别；加上 `--proba` 会同时输出各类概率。

### 数据准备要点
- 必须有真实标签字段（例：`label`），例如“不锈钢压力表”。没有标签就无法监督训练。
- 强烈建议排除泄漏特征（如 `id`、`created_time`、`updated_time`、`function_tag`、任意直接包含目标含义的派生字段）。
- 缺失字段推理时可留空，系统会自动补 None 并按训练时的列顺序对齐。
- 类别极不平衡时可在 `model` 段设置 `class_weights`（例如 `{不锈钢压力表: 2.0, 其他: 1.0}`），或先做欠采样/过采样。
- 如果想把“材质+类型”规则先做弱标注（辅助构造 `label`），可在建模前用简单脚本生成 `label` 字段，再交给模型学习更复杂的组合关系。

### 代码变更要点
- 新增训练对 JSON 输入的支持、自动识别类别特征与元数据保存：`dalong_catboost/cli.py`
- 新增推理入口：`dalong_catboost/predict_cli.py`
- 新增脚本入口：`pyproject.toml` 增加 `dalong-catboost-predict`

如果你给我一个包含真实 `label` 的小样本（几十到几百条），我可以立即帮你验证训练效果与推理输出，并微调配置（比如迭代轮数、深度、特征列）。

- 新增：训练 CLI 支持 `data.train_json`；保存元数据 `<model>.meta.json`。
- 新增：`dalong-catboost-predict`，可对单条或文件 JSON 推理，自动对齐训练特征列。

---

训练这个分类模型，建议的标记数量推荐是多少

### 简短结论
- 若有 10–20 个主力类别：先标注 3k–5k，总体能出稳定模型；每类至少 150–300 条更稳，100/类可跑但波动大。
- 若类别很多（>50）且长尾明显：优先覆盖前 20–30 个高频类（每类 200–300），长尾先并入“其他”，后续再精细化；总标注 5k–10k 更合适。
- 如特征区分度强（如材质/功能/装置位号能明显区分类别）：每类 100–200 就可有不错基线；区分度弱则需要 300–500/类。

### 具体建议（可直接照做）
- 标注第一轮（起步集）：
  - 覆盖 Top-20 高频类别，每类 ≥150（最好 200–300），总量约 4k–6k。
  - 长尾类别先合并到“其他”，或仅抽样标注 ≥50/类用于监控可分性。
- 评估与扩标策略：
  - 用 5 折交叉验证看 Macro-F1。若再多标 1k–2k，Macro-F1 提升 <1 个百分点，可停止扩标。
  - 对误分最多的类别定向补标（不均衡时开启 `class_weights`）。
  - 做学习曲线：1k → 2k → 5k → 8k，找到性能平台期。
- 标注效率提升：
  - 主动学习（不确定性采样）：小集训练后挑置信度最低的样本加标，常可节省 30–60% 标注量。
  - 分层抽样：按 `instrument_type`、`instrument_name`、`assembly_material` 等分层，确保各层均衡进样。
  - 去重/相似样本合并，保证标注多样性，避免“重复样本堆叠”。

### 经验数值速查
- “不锈钢压力表”等主力类别：100/类能跑基线，200–300/类较稳，500/类更鲁棒。
- 总量：3k–5k 起步集；类别多且复杂时 5k–10k 较佳。
- 高基数类别特征（如大量不同 `location`/`material` 值）：尽量覆盖高频取值，每个取值有几十条样本更稳。

如你能给出预计要区分的类别清单与各类别的大致占比，我可以给出更精确的每类标注配额与第一轮标注清单。

